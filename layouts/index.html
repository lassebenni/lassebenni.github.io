{{- define "main" }}


{{/* Newsletter Subscription (home only) */}}
{{- $provider := (index .Site.Params "newsletter").provider }}
{{- if eq $provider "buttondown" }}
{{- $newsletterHandle := (index .Site.Params "newsletter").handle }}
<div class="header-subscribe home-subscribe" style="margin: 1.25rem auto 2rem; width: 100%; max-width: 560px; padding: 10px 12px; border-radius: 10px;">
  <form
    action="https://buttondown.email/api/emails/embed-subscribe/{{ $newsletterHandle }}"
    method="post"
    target="popupwindow"
    onsubmit="window.open('https://buttondown.email/{{ $newsletterHandle }}', 'popupwindow')"
    class="embeddable-buttondown-form">
    <span class="subscribe-text">ðŸ“§ Subscribe to new posts by email:</span>
    <input type="email" name="email" placeholder="you@example.com" required class="subscribe-input">
    <input type="hidden" value="1" name="embed"/>
    <button type="submit" class="subscribe-button">Subscribe</button>
  </form>
</div>
{{- end }}

{{/* Latest Posts Section */}}
<header class="page-header">
    <h2>Latest Posts</h2>
</header>

{{- $pages := where site.RegularPages "Type" "in" site.Params.mainSections }}
{{- $paginator := .Paginate (first 5 $pages) }}

{{- if $paginator.Pages }}
{{- range $paginator.Pages }}
{{- $class := "post-entry" }}

{{- $user_preferred := or site.Params.disableSpecial1stPost site.Params.homeInfoParams }}
{{- if (and $.IsHome (eq .Weight 0) (not $user_preferred)) }}
{{- $class = "first-entry" }}
{{- else if .Weight }}
{{- $class = "post-entry featured" }}
{{- end }}

<article class="{{ $class }}">
    {{- $isHidden := (.Param "cover.hiddenInSingle") | default (.Param "cover.hidden") | default false }}
    {{- partial "cover.html" (dict "cxt" . "IsHome" true "isHidden" $isHidden) }}
    <header class="entry-header">
        <h2 class="entry-hint-parent">
            <a href="{{ .Permalink }}">{{ .Title }}</a>
        </h2>
    </header>
    {{- if (.Param "ShowSummary") | default (.Site.Params.ShowSummary) }}
    {{- $teaser := .Params.ai_summary -}}
    {{- if not $teaser -}}{{- $teaser = .Description -}}{{- end -}}
    {{- if not $teaser -}}{{- $teaser = (.Summary | plainify | htmlUnescape) -}}{{- end -}}
    <div class="entry-content">
        <p>{{ $teaser }}</p>
    </div>
    {{- end }}
    <footer class="entry-footer">
        <div class="entry-footer-details">
            {{- partial "post_meta.html" . -}}
        </div>
        {{- if .Params.tags }}
        <div class="entry-tags">
            {{- range .Params.tags }}
            <a class="tag" href="{{ "/tags/" | relURL }}{{ . | urlize }}/">{{ . }}</a>
            {{- end }}
        </div>
        {{- end }}
    </footer>
    <a class="entry-link" aria-label="post link to {{ .Title | plainify }}" href="{{ .Permalink }}"></a>
</article>
{{- end }}

{{- if gt $paginator.TotalPages 1 }}
<footer class="page-footer">
    <nav class="pagination">
        {{- if $paginator.HasPrev }}
        <a class="prev" href="{{ $paginator.Prev.URL | absURL }}">
            Â« {{ i18n "prev_page" }}
        </a>
        {{- end }}
        {{- if $paginator.HasNext }}
        <a class="next" href="{{ $paginator.Next.URL | absURL }}">
            {{ i18n "next_page" }} Â»
        </a>
        {{- end }}
    </nav>
</footer>
{{- end }}

{{- else }}
{{- if .IsHome }}
<div class="empty-state" style="text-align: center; padding: 3rem 0;">
    <h3>No posts yet</h3>
    <p>Check back soon for new content!</p>
</div>
{{- end }}
{{- end }}

{{- end }}{{/* end main */}}
